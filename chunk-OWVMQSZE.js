import{a as he}from"./chunk-GOSNS7PG.js";import{a as le,b as S,c as N,d as ce,e as me,f as C,g as de,h as pe,i as ue,j as ge,k as $,l as D,m as j,n as ke,o as be}from"./chunk-YDCFJKCP.js";import{a as v}from"./chunk-YK4R6DJK.js";import{a as ae}from"./chunk-YVELGN4G.js";import{a as oe}from"./chunk-B4TRIBHJ.js";import{$ as ie,A as J,C as K,E as l,J as b,K as m,L as A,M as U,N as n,O as i,P as w,Q as _,R as d,S as k,T as X,U as Y,V as Z,W as a,X as h,Y as f,Z as ee,_ as te,a as z,b as q,ba as y,ca as E,da as H,ea as B,g as F,j as T,la as I,ma as O,na as M,o as Q,oa as se,pa as V,qa as ne,ra as G,s as g,sa as re,t as P,w as W,x as p,y as u}from"./chunk-6PQSHQPV.js";var x=class r{toast=g(v);http=g(re);url=`${ae.apiUrl}tasks/`;tasksSubject=new F([]);tasks$=this.tasksSubject.asObservable();totalPagesSubject=new F(1);totalPages$=this.totalPagesSubject.asObservable();selectedTaskSubject=new F(null);selectedTask$=this.selectedTaskSubject.asObservable();platformId=g(K);currentPage=1;limit=10;getHeaders(){return ne(this.platformId)?new G({Authorization:"Bearer "+window.localStorage.getItem("accessToken")}):new G({Authorization:"Bearer "})}getTasks(e=1,t=""){let s=`${this.url}getTasks?page=${e}&limit=${this.limit}`;t&&(s+=`&status=${t}`),this.http.get(s,{headers:this.getHeaders()}).pipe(T(o=>(this.totalPagesSubject.next(o.totalPages),o.data))).subscribe(o=>{this.tasksSubject.next(o),this.toast.closeModalLoading()})}updateTask(e,t){return this.http.put(`${this.url}updateTask/${e}`,t,{headers:this.getHeaders()}).pipe(T(s=>(this.getTasks(this.currentPage),s)))}changeTaskStatus(e,t){return this.http.put(`${this.url}changeTaskStatus/${e}`,t,{headers:this.getHeaders()}).pipe(T(s=>(this.getTasks(this.currentPage),s)))}setSelectedTask(e){this.selectedTaskSubject.next(e)}getSelectedTask(){return this.selectedTaskSubject.getValue()}deleteTask(e){return this.http.delete(`${this.url}deleteTask/${e.id}`,{headers:this.getHeaders()}).pipe(T(t=>(this.getTasks(this.currentPage),t)))}getCurrentPage(){return this.currentPage}createTask(e){return this.http.post(`${this.url}createTask`,e,{headers:this.getHeaders()}).pipe(T(t=>(this.getTasks(this.currentPage),t)))}setCurrentPage(e){this.currentPage=e,this.getTasks(e)}static \u0275fac=function(t){return new(t||r)};static \u0275prov=Q({token:r,factory:r.\u0275fac,providedIn:"root"})};var Ce=(r,e)=>({"btn-danger":r,"btn-primary":e});function xe(r,e){r&1&&(n(0,"div",16),a(1," El t\xEDtulo es obligatorio (m\xEDnimo 3 caracteres). "),i())}function we(r,e){if(r&1){let t=_();n(0,"li",20)(1,"div",21)(2,"button",22),d("click",function(){let o=p(t).$implicit,c=k(2);return u(c.toggleUserSelection(o))}),a(3),i(),n(4,"div",23)(5,"span",24),a(6),i(),n(7,"span",25),a(8),i()()()()}if(r&2){let t=e.$implicit,s=k(2);l(2),m("ngClass",E(4,Ce,s.isSelected(t),!s.isSelected(t))),l(),f(" ",s.isSelected(t)?"Quitar":"Agregar"," "),l(3),h(t.name),l(2),h(t.email)}}function Ee(r,e){if(r&1&&(n(0,"div",17)(1,"ul",18),b(2,we,9,7,"li",19),i()()),r&2){let t=k();l(2),m("ngForOf",t.users)}}function Fe(r,e){if(r&1){let t=_();n(0,"li")(1,"span",27),d("click",function(){let o=p(t).$implicit,c=k(2);return u(c.removeUser(o))}),a(2,"\u274C"),i(),a(3),i()}if(r&2){let t=e.$implicit;l(3),f(" ",t.name," ")}}function Pe(r,e){if(r&1&&(n(0,"div")(1,"strong"),a(2,"Usuarios seleccionados:"),i(),n(3,"ul"),b(4,Fe,4,1,"li",26),i()()),r&2){let t=k();l(4),m("ngForOf",t.selectedUsers)}}function Ue(r,e){r&1&&a(0,"Editar")}function ye(r,e){r&1&&a(0,"Crear")}var L=class r{closeModalTask=new J;userLocalService=g(oe);usersService=g(he);taskService=g(x);toast=g(v);taskSubscription=null;userSubscription=null;currentUser=null;selectedUsers=[];task=null;users=[];taskForm=new me({title:new C("",[S.required,S.minLength(3)]),status:new C("pending",S.required),description:new C("",S.maxLength(500)),owners:new C([],S.required),searchTerm:new C("")});ngOnInit(){this.taskSubscription=this.taskService.selectedTask$.subscribe(e=>{this.task=e,e?(this.taskForm.patchValue(e),this.selectedUsers=e.owners.filter(t=>t.idUser!==this.currentUser?.idUser),this.ensureCurrentUserInOwners()):this.resetForm()}),this.userSubscription=this.userLocalService.user$.subscribe(e=>{this.currentUser=e,this.ensureCurrentUserInOwners()})}ngOnChanges(e){e.task&&this.task&&(this.taskForm.patchValue(this.task),this.selectedUsers=this.task.owners.filter(t=>t.idUser!==this.currentUser?.idUser),this.ensureCurrentUserInOwners())}ensureCurrentUserInOwners(){if(this.currentUser?.idUser){let e=this.taskForm.get("owners")?.value||[];e.includes(this.currentUser.idUser)||this.taskForm.patchValue({owners:[this.currentUser.idUser,...e]})}}searchUsers(){if(this.taskForm.get("searchTerm")?.value.trim()===""){this.users=[];return}this.usersService.searchUsers(this.taskForm.get("searchTerm")?.value).subscribe(e=>{this.users=e.message.filter(t=>t.idUser!==this.currentUser?.idUser)})}toggleUserSelection(e){this.isSelected(e)?this.selectedUsers=this.selectedUsers.filter(t=>t.idUser!==e.idUser):this.selectedUsers.push(e),this.updateOwners()}removeUser(e){e.idUser!==this.currentUser?.idUser&&(this.selectedUsers=this.selectedUsers.filter(t=>t.idUser!==e.idUser)),this.updateOwners()}updateOwners(){this.currentUser?.idUser&&this.taskForm.patchValue({owners:[this.currentUser.idUser,...this.selectedUsers.map(e=>e.idUser)]})}isSelected(e){return this.selectedUsers.some(t=>t.idUser===e.idUser)}saveTask(){if(this.taskForm.invalid){this.toast.setToastPopup("Por favor, completa correctamente los campos.","error");return}let e=q(z({},this.taskForm.value),{owners:[this.currentUser?.idUser,...this.selectedUsers.map(t=>t.idUser)]});this.task?this.taskService.updateTask(this.task.id,e).subscribe(()=>{this.toast.setToastPopup("Tarea actualizada correctamente.","success"),this.closeModalTask.emit(),this.resetForm()}):this.taskService.createTask(e).subscribe(()=>{this.toast.setToastPopup("Tarea creada correctamente.","success"),this.closeModalTask.emit(),this.resetForm()})}resetForm(){this.selectedUsers=[],this.users=[],this.taskForm.reset({owners:[this.currentUser?.idUser],status:"pending",description:"",searchTerm:"",title:""})}ngOnDestroy(){this.taskSubscription?.unsubscribe(),this.userSubscription?.unsubscribe()}static \u0275fac=function(t){return new(t||r)};static \u0275cmp=P({type:r,selectors:[["app-task-form"]],outputs:{closeModalTask:"closeModalTask"},standalone:!0,features:[W,y],decls:29,vars:6,consts:[[3,"formGroup"],[1,"mb-3"],["for","title",1,"form-label"],["type","text","id","title","formControlName","title","placeholder","Ingresa un t\xEDtulo",1,"form-control"],["class","text-danger",4,"ngIf"],["for","description",1,"form-label"],["id","description","formControlName","description","rows","3","placeholder","Ingresa una descripci\xF3n (opcional)",1,"form-control"],[1,"form-label"],["formControlName","status",1,"form-select"],["value","pending"],["value","completed"],["type","text","placeholder","Buscar usuarios por nombre o correo...","formControlName","searchTerm",1,"form-control",3,"input"],["class","scroll-box user-list",4,"ngIf"],[4,"ngIf"],[1,"text-center"],["type","submit",1,"btn","btn-primary",3,"click","disabled"],[1,"text-danger"],[1,"scroll-box","user-list"],[1,"list-group","mb-3"],["class","list-group-item",4,"ngFor","ngForOf"],[1,"list-group-item"],[1,"d-flex","align-items-center","gap-2"],[1,"btn","btn-sm",2,"width","auto",3,"click","ngClass"],[1,"d-flex","flex-column"],[1,"fw-bold"],[1,"text-muted","small"],[4,"ngFor","ngForOf"],[2,"cursor","pointer",3,"click"]],template:function(t,s){if(t&1&&(n(0,"form",0)(1,"div",1)(2,"label",2),a(3,"T\xEDtulo"),i(),w(4,"input",3),b(5,xe,2,0,"div",4),i(),n(6,"div",1)(7,"label",5),a(8,"Descripci\xF3n"),i(),w(9,"textarea",6),i(),n(10,"div",1)(11,"label",7),a(12,"Estado"),i(),n(13,"select",8)(14,"option",9),a(15,"Pendiente"),i(),n(16,"option",10),a(17,"Completada"),i()()(),n(18,"div",1)(19,"label",7),a(20,"Compartir con usuarios"),i(),n(21,"input",11),d("input",function(){return s.searchUsers()}),i()(),b(22,Ee,3,1,"div",12)(23,Pe,5,1,"div",13),n(24,"div",14)(25,"button",15),d("click",function(){return s.saveTask()}),b(26,Ue,1,0)(27,ye,1,0),a(28," tarea "),i()()()),t&2){let o;m("formGroup",s.taskForm),l(5),m("ngIf",((o=s.taskForm.get("title"))==null?null:o.invalid)&&((o=s.taskForm.get("title"))==null?null:o.touched)),l(17),m("ngIf",s.users.length>0),l(),m("ngIf",s.selectedUsers.length>0),l(2),m("disabled",s.taskForm.invalid),l(),U(s.task?26:27)}},dependencies:[V,I,O,M,be,pe,D,j,le,$,N,ce,ue,ge],styles:[".container[_ngcontent-%COMP%]{max-width:500px;background:#fff;padding:20px;border-radius:8px;box-shadow:0 4px 6px #0000001a}h2[_ngcontent-%COMP%]{margin-bottom:20px}button[_ngcontent-%COMP%]{width:100%}"]})};var Ie=["taskModal"],Oe=(r,e)=>({"bg-success":r,"bg-warning":e}),Me=(r,e)=>({"btn-success":r,"btn-warning":e});function Ve(r,e){if(r&1){let t=_();n(0,"tr")(1,"td"),a(2),i(),n(3,"td")(4,"span",30),a(5),i()(),n(6,"td"),a(7),i(),n(8,"td"),a(9),i(),n(10,"td")(11,"button",31),d("click",function(){let o=p(t).$implicit,c=k(2);return u(c.changeTaskStatus(o))}),a(12),i()(),n(13,"td")(14,"div",32)(15,"button",33),d("click",function(){let o=p(t).$implicit,c=k(2);return u(c.openEditModal(o))}),a(16," \u270F\uFE0F "),i(),n(17,"button",34),d("click",function(){let o=p(t).$implicit,c=k(2);return u(c.deleteTask(o))}),a(18,"\u274C"),i()()()()}if(r&2){let t=e.$implicit,s=e.index,o=k(2);l(2),h((o.currentPage-1)*o.pageSize+s+1),l(2),m("ngClass",E(7,Oe,t.status==="completed",t.status==="pending")),l(),f(" ",t.status==="completed"?"Completado":"Pendiente"," "),l(2),h(t.title),l(2),h(t.description),l(2),m("ngClass",E(10,Me,t.status==="pending",t.status==="completed")),l(),f(" ",t.status==="pending"?"Completar":"Pendiente"," ")}}function Ne(r,e){if(r&1&&(n(0,"tbody"),b(1,Ve,19,13,"tr",29),i()),r&2){let t=e.ngIf;l(),m("ngForOf",t)}}function $e(r,e){r&1&&a(0,"Editar")}function De(r,e){r&1&&a(0,"Crear")}var Te=class r{taskModal;taskService=g(x);toast=g(v);totalPages$=this.taskService.totalPages$;tasks$=this.taskService.tasks$;selectedStatus="";currentPage=1;pageSize=10;ngOnInit(){this.getTasks()}changePage(e){this.currentPage=e,this.getTasks()}getTasks(){this.toast.showModalLoading(),this.taskService.getTasks(this.currentPage,this.selectedStatus)}filterTasks(){this.currentPage=1,this.getTasks()}openEditModal(e){this.taskService.setSelectedTask(e)}closeModalTask(){if(this.taskService.setSelectedTask(null),this.taskModal){let e=this.taskModal.nativeElement.querySelector(".btn-close");e&&e.click()}}deleteTask(e){this.toast.showModalConfirm("\xBFEst\xE1s seguro de eliminar esta tarea?",t=>{t.isConfirmed&&this.taskService.deleteTask(e).subscribe(()=>{this.toast.setToastPopup("Tarea eliminada correctamente.","success"),this.getTasks()})})}changeTaskStatus(e){let t=e.status==="pending"?"completed":"pending";this.taskService.changeTaskStatus(e.id,{status:t}).subscribe(()=>{this.toast.setToastPopup(`Tarea marcada como ${t==="completed"?"completada":"pendiente"}.`,"success"),this.getTasks()})}static \u0275fac=function(t){return new(t||r)};static \u0275cmp=P({type:r,selectors:[["app-tasks"]],viewQuery:function(t,s){if(t&1&&X(Ie,5),t&2){let o;Y(o=Z())&&(s.taskModal=o.first)}},standalone:!0,features:[y],decls:58,vars:12,consts:[["taskModal",""],[1,"container","mt-4"],[1,"mb-3","text-center"],[1,"d-flex","justify-content-between","align-items-center","mb-3"],[1,"d-flex","align-items-center"],["for","statusFilter",1,"me-2"],["id","statusFilter",1,"form-select","w-auto",3,"ngModelChange","change","ngModel"],["value",""],["value","pending"],["value","completed"],["data-bs-target","#taskModal","data-bs-toggle","modal",1,"btn","btn-primary",3,"click"],[1,"table-responsive"],[1,"table","table-striped","table-bordered"],[1,"table-dark"],[4,"ngIf"],[1,"mt-3"],[1,"pagination","justify-content-center"],[1,"page-item"],[1,"page-link",3,"click"],[1,"page-item","disabled"],[1,"page-link"],["id","taskModal","tabindex","-1","aria-labelledby","taskModalLabel","aria-hidden","true",1,"modal","fade"],[1,"modal-dialog"],[1,"modal-content"],[1,"modal-header"],["id","taskModalLabel",1,"modal-title"],["type","button","data-bs-dismiss","modal","aria-label","Close",1,"btn-close"],[1,"modal-body"],[3,"closeModalTask"],[4,"ngFor","ngForOf"],[1,"badge",3,"ngClass"],[1,"btn","btn-sm",3,"click","ngClass"],[1,"d-flex","justify-content-center","align-items-center"],["data-bs-target","#taskModal","data-bs-toggle","modal",1,"btn","btn-sm","btn","btn-outline-warning","me-2",3,"click"],[1,"btn","btn-sm","btn","btn-outline-danger","me-2",3,"click"]],template:function(t,s){if(t&1){let o=_();n(0,"div",1)(1,"h2",2),a(2,"Listado de tareas"),i(),n(3,"div",3)(4,"div",4)(5,"label",5),a(6,"Filtrar por estado:"),i(),n(7,"select",6),ie("ngModelChange",function(R){return p(o),te(s.selectedStatus,R)||(s.selectedStatus=R),u(R)}),d("change",function(){return p(o),u(s.filterTasks())}),n(8,"option",7),a(9,"Todos"),i(),n(10,"option",8),a(11,"Pendiente"),i(),n(12,"option",9),a(13,"Completado"),i()()(),n(14,"button",10),d("click",function(){return p(o),u(s.taskService.setSelectedTask(null))}),a(15," + Nueva Tarea "),i()(),n(16,"div",11)(17,"table",12)(18,"thead",13)(19,"tr")(20,"th"),a(21,"#"),i(),n(22,"th"),a(23,"Estado"),i(),n(24,"th"),a(25,"T\xEDtulo"),i(),n(26,"th"),a(27,"Descripci\xF3n"),i(),n(28,"th"),a(29,"Cambiar estado"),i(),n(30,"th"),a(31,"Acciones"),i()()(),b(32,Ne,2,1,"tbody",14),H(33,"async"),i()(),n(34,"nav",15)(35,"ul",16)(36,"li",17)(37,"button",18),d("click",function(){return p(o),u(s.changePage(s.currentPage-1))}),a(38,"Anterior"),i()(),n(39,"li",19)(40,"span",20),a(41),i()(),n(42,"li",17),H(43,"async"),n(44,"button",18),d("click",function(){return p(o),u(s.changePage(s.currentPage+1))}),a(45,"Siguiente"),i()()()()(),n(46,"div",21,0)(48,"div",22)(49,"div",23)(50,"div",24)(51,"h5",25),b(52,$e,1,0)(53,De,1,0),a(54," tarea"),i(),w(55,"button",26),i(),n(56,"div",27)(57,"app-task-form",28),d("closeModalTask",function(){return p(o),u(s.closeModalTask())}),i()()()()()}t&2&&(l(7),ee("ngModel",s.selectedStatus),l(25),m("ngIf",B(33,8,s.tasks$)),l(4),A("disabled",s.currentPage===1),l(5),f("P\xE1gina ",s.currentPage,""),l(),A("disabled",B(43,10,s.totalPages$)===s.currentPage),l(10),U(s.taskService.getSelectedTask()?52:53))},dependencies:[V,I,O,M,se,L,ke,D,j,$,N,de],styles:[".container[_ngcontent-%COMP%]{max-width:800px}.table[_ngcontent-%COMP%]{text-align:center}.badge[_ngcontent-%COMP%]{font-size:1rem;padding:5px 10px}"]})};export{Te as TasksComponent};
